// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* ---------- Enums ---------- */

enum PropertyType {
  APPARTEMENT
  MAISON
  STUDIO
  LOFT
  LOCAL
}

enum ListingStatus {
  PUBLISHED
  DRAFT
  ARCHIVED
}

enum LeaseType {
  VIDE
  MEUBLE
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  PREQUALIFIED   // scoring ok, peut r√©server une visite
  REJECTED
  APPROVED       // final accept√© par le proprio
}

enum DocumentStatus {
  PENDING
  VALID
  INVALID
}

enum DocumentType {
  IDENTITE
  JUSTIF_DOMICILE
  CONTRAT_TRAVAIL
  BULLETIN_SALAIRE_1
  BULLETIN_SALAIRE_2
  BULLETIN_SALAIRE_3
  AVIS_IMPOSITION
  ATTESTATION_ETUDIANT
  GARANT_IDENTITE
  GARANT_JUSTIF_DOMICILE
  GARANT_BULLETIN_1
  GARANT_BULLETIN_2
  GARANT_BULLETIN_3
  AUTRE
}

/* ---------- Mod√®les ---------- */

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  name      String?
  role      String?   // "owner" | "tenant" | autre

  // Propri√©taire ‚Üí ses annonces
  listings  Listing[] @relation("OwnerListings")

  // üëá Inverse de Application.applicant (relation nomm√©e)
  applicationsApplied Application[] @relation("ApplicantApplications")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Listing {
  id            String        @id @default(cuid())
  title         String
  description   String
  type          PropertyType
  leaseType     LeaseType
  city          String
  address       String?
  lat           Float?
  lng           Float?
  rent          Int            // en euros
  charges       Int            // en euros
  bedrooms      Int
  surface       Int            // m2
  furnished     Boolean        @default(false)
  status        ListingStatus  @default(PUBLISHED)
  availableAt   DateTime?

  ownerId       String
  owner         User           @relation("OwnerListings", fields: [ownerId], references: [id])

  images        ListingImage[]
  applications  Application[]      // dossiers rattach√©s √† cette annonce
  visitSlots    VisitSlot[]        // cr√©neaux de visite

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([status, city, type])
  @@index([rent])
  @@index([availableAt])
}

model ListingImage {
  id        String  @id @default(cuid())
  url       String
  alt       String?
  listingId String
  listing   Listing @relation(fields: [listingId], references: [id])
  sort      Int     @default(0)
}

model Application {
  id          String            @id @default(cuid())
  listingId   String
  listing     Listing           @relation(fields: [listingId], references: [id])

  // Champs ‚Äúcontact‚Äù historiques (laisse-les optionnels pour r√©trocompat)
  name        String?
  email       String?
  message     String?

  // Candidat (Supabase Auth user) ‚Äî relation nomm√©e avec inverse c√¥t√© User
  applicantId String?
  applicant   User?             @relation("ApplicantApplications", fields: [applicantId], references: [id])

  // Statut & scoring du dossier
  status      ApplicationStatus @default(DRAFT)
  score       Int               @default(0)
  note        String?

  // Cr√©neau de visite √©ventuellement r√©serv√©
  visitSlotId String?
  visitSlot   VisitSlot?        @relation(fields: [visitSlotId], references: [id])

  // Pi√®ces du dossier
  documents   ApplicationDocument[]

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([listingId, applicantId])
}

model ApplicationDocument {
  id            String         @id @default(cuid())
  applicationId String
  application   Application    @relation(fields: [applicationId], references: [id])

  type          DocumentType
  url           String
  status        DocumentStatus  @default(PENDING)
  reason        String?         // si INVALID : pourquoi

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model VisitSlot {
  id         String   @id @default(cuid())
  listingId  String
  listing    Listing  @relation(fields: [listingId], references: [id])

  start      DateTime
  end        DateTime
  capacity   Int       @default(1)
  booked     Int       @default(0)

  applications Application[]     // applications ayant r√©serv√© ce cr√©neau

  createdAt  DateTime @default(now())

  @@index([listingId, start])
}
